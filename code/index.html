<!DOCTYPE html>
<html>
<head>
  <base target="_top">
  <title>動画録画アプリ (画質・カメラ切替対応)</title>
  <style>
    /* CSSは変更なし */
    body { font-family: sans-serif; margin: 20px; background-color: #f4f4f4; color: #333; }
    .container { background-color: #fff; padding: 20px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); max-width: 640px; margin: auto;}
    h1 { color: #d9534f; text-align: center; }
    .video-container { position: relative; background-color: #000; margin-bottom: 15px; width: 100%; max-width: 600px; margin-left: auto; margin-right: auto; }
    video { width: 100%; display: block; border-radius: 4px; }
    #videoPlayback { display: none; }
    .input-group { margin-bottom: 15px; }
    .input-group label { display: block; margin-bottom: 5px; font-weight: bold; }
    .input-group input[type="text"], .input-group select { width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 4px; box-sizing: border-box; }
    .button-group { text-align: center; }
    button { background-color: #d9534f; color: white; border: none; padding: 10px 20px; text-align: center; font-size: 16px; margin: 10px 5px; cursor: pointer; border-radius: 5px; transition: background-color 0.3s ease; }
    button:hover { background-color: #c9302c; }
    button:disabled { background-color: #cccccc; cursor: not-allowed; }
    #status { margin-top: 15px; padding: 10px; background-color: #e9ecef; border-radius: 5px; text-align: center; font-weight: bold; min-height: 20px; line-height: 1.5; }
  </style>
</head>
<body>
  <div class="container">
    <h1>動画録画アプリ (画質・カメラ切替対応)</h1>
    <div class="video-container">
      <video id="previewVideo" autoplay muted playsinline></video>
      <video id="videoPlayback" controls></video>
    </div>

    <div class="input-group" id="cameraSelectorContainer" style="display:none;">
      <label for="cameraSelect">カメラ:</label>
      <select id="cameraSelect"></select>
    </div>
    
    <!-- ▼▼▼ 画質選択用のUIを追加 ▼▼▼ -->
    <div class="input-group">
      <label for="qualitySelect">画質:</label>
      <select id="qualitySelect">
        <option value="low">低画質 (480p)</option>
        <option value="medium" selected>中画質 (720p / 推奨)</option>
        <option value="high">高画質 (1080p)</option>
      </select>
    </div>
    <!-- ▲▲▲ ここまで ▲▲▲ -->

    <div class="input-group">
      <label for="prefixName">グループ名/ペア名 (ファイル名の先頭に付きます):</label>
      <input type="text" id="prefixName" placeholder="例: TeamA, John_Jane">
    </div>

    <div class="button-group">
      <button id="recordButton">録画開始</button>
      <button id="stopButton" disabled>停止</button>
      <button id="saveButton" disabled>ドライブに保存</button>
    </div>

    <div id="status">カメラとマイクへのアクセスを許可してください。</div>
  </div>

  <script>
    const recordButton = document.getElementById('recordButton');
    const stopButton = document.getElementById('stopButton');
    const saveButton = document.getElementById('saveButton');
    const statusDisplay = document.getElementById('status');
    const previewVideo = document.getElementById('previewVideo');
    const videoPlayback = document.getElementById('videoPlayback');
    const prefixNameInput = document.getElementById('prefixName');
    const cameraSelect = document.getElementById('cameraSelect');
    const cameraSelectorContainer = document.getElementById('cameraSelectorContainer');
    
    // ▼▼▼ 画質選択UIの要素とプリセットを定義 ▼▼▼
    const qualitySelect = document.getElementById('qualitySelect');
    const QUALITY_PRESETS = {
      low: {
        width: { ideal: 640 },
        height: { ideal: 480 },
        videoBitsPerSecond: 500000, // 500 kbps
      },
      medium: {
        width: { ideal: 1280 },
        height: { ideal: 720 },
        videoBitsPerSecond: 2000000, // 2 Mbps
      },
      high: {
        width: { ideal: 1920 },
        height: { ideal: 1080 },
        videoBitsPerSecond: 4500000, // 4.5 Mbps
      }
    };
    // ▲▲▲ ここまで ▲▲▲

    let mediaRecorder, videoChunks = [], originalVideoBlob = null, stream = null;

    // カメラ選択肢の生成 (変更なし)
    async function setupCameraSelector() { /* ... 変更なし ... */ }

    // 録画開始処理
    recordButton.onclick = async () => {
      try {
        // ▼▼▼ 選択された画質プリセットを取得 ▼▼▼
        const selectedQuality = qualitySelect.value;
        const preset = QUALITY_PRESETS[selectedQuality];
        
        const videoConstraints = {
          width: preset.width,
          height: preset.height
        };
        if (cameraSelect.value) {
          videoConstraints.deviceId = { exact: cameraSelect.value };
        }
        stream = await navigator.mediaDevices.getUserMedia({ video: videoConstraints, audio: true });
        
        // ▼▼▼ MediaRecorderにビットレートを設定 ▼▼▼
        const mediaRecorderOptions = {
          mimeType: 'video/webm',
          videoBitsPerSecond: preset.videoBitsPerSecond
        };
        mediaRecorder = new MediaRecorder(stream, mediaRecorderOptions);
        // ▲▲▲ ここまで ▲▲▲
        
        previewVideo.srcObject = stream;
        previewVideo.style.display = 'block';
        videoPlayback.style.display = 'none';
        mediaRecorder.ondataavailable = event => videoChunks.push(event.data);
        mediaRecorder.onstop = () => {
          originalVideoBlob = new Blob(videoChunks, { type: mediaRecorder.mimeType });
          videoPlayback.src = URL.createObjectURL(originalVideoBlob);
          previewVideo.style.display = 'none';
          videoPlayback.style.display = 'block';
          // UIの状態更新
          recordButton.disabled = false;
          stopButton.disabled = true;
          saveButton.disabled = false;
          prefixNameInput.disabled = false;
          cameraSelect.disabled = false;
          qualitySelect.disabled = false; // ★追加
          statusDisplay.textContent = '録画停止。再生または保存が可能です。';
          videoChunks = [];
        };
        videoChunks = [];
        mediaRecorder.start();
        statusDisplay.textContent = '録画中...';
        // UIの状態更新
        recordButton.disabled = true;
        stopButton.disabled = false;
        saveButton.disabled = true;
        prefixNameInput.disabled = true;
        cameraSelect.disabled = true;
        qualitySelect.disabled = true; // ★追加
      } catch (err) {
        statusDisplay.textContent = 'エラー: カメラ/マイクにアクセスできませんでした。';
        console.error(err);
      }
    };

    // 録画停止処理 (変更なし)
    stopButton.onclick = () => { /* ... 変更なし ... */ };

    // 保存処理 (UIの状態更新に qualitySelect を追加)
    saveButton.onclick = () => {
      if (!originalVideoBlob) {
        statusDisplay.textContent = '保存する録画データがありません。';
        return;
      }
      statusDisplay.textContent = 'ドライブに保存中... しばらくお待ちください。';
      recordButton.disabled = true;
      saveButton.disabled = true;
      prefixNameInput.disabled = true;
      cameraSelect.disabled = true;
      qualitySelect.disabled = true; // ★追加

      const reader = new FileReader();
      reader.readAsDataURL(originalVideoBlob);
      reader.onloadend = () => {
        const dataUrl = reader.result;
        const userPrefix = prefixNameInput.value.trim().replace(/[\s\\\/:\*\?"<>\|]/g, '_') || "unknown";
        const timestamp = new Date().toISOString().replace(/[:.]/g, '-');
        const baseFileName = `${userPrefix}_recording-${timestamp}`;

        google.script.run
          .withSuccessHandler(response => {
            if (response.success) {
              statusDisplay.textContent = response.message;
              saveButton.disabled = true;
            } else {
              statusDisplay.textContent = `保存失敗: ${response.message}`;
              saveButton.disabled = false;
            }
            recordButton.disabled = false;
            prefixNameInput.disabled = false;
            cameraSelect.disabled = false;
            qualitySelect.disabled = false; // ★追加
          })
          .withFailureHandler(error => {
            statusDisplay.textContent = `サーバーエラー: ${error.message}`;
            recordButton.disabled = false;
            saveButton.disabled = false;
            prefixNameInput.disabled = false;
            cameraSelect.disabled = false;
            qualitySelect.disabled = false; // ★追加
          })
          .saveVideoFile(dataUrl, baseFileName);
      };
      reader.onerror = () => {
        statusDisplay.textContent = 'ファイルの読み込みに失敗しました。';
        recordButton.disabled = false;
        saveButton.disabled = false;
        prefixNameInput.disabled = false;
        cameraSelect.disabled = false;
        qualitySelect.disabled = false; // ★追加
      }
    };
    
    // 変更がない関数のコード（短縮表示）
    setupCameraSelector = async () => { try { const devices = await navigator.mediaDevices.enumerateDevices(); const videoDevices = devices.filter(d => d.kind === 'videoinput'); cameraSelect.innerHTML = ''; if (videoDevices.length > 1) { videoDevices.forEach(d => { const o = document.createElement('option'); o.value = d.deviceId; o.text = d.label || `カメラ ${cameraSelect.length + 1}`; cameraSelect.appendChild(o); }); cameraSelectorContainer.style.display = 'block'; } else { cameraSelectorContainer.style.display = 'none'; } } catch (e) { console.error(e); } };
    stopButton.onclick = () => { if (mediaRecorder?.state !== "inactive") { mediaRecorder.stop(); stream?.getTracks().forEach(t => t.stop()); stream = null; previewVideo.srcObject = null; } };

    // ページ読み込み時にカメラのリストアップを実行
    window.addEventListener('load', setupCameraSelector);
  </script>
</body>
</html>
